<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/pdf.service.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/pdf.service.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// Importación de librerías necesarias
import { launch } from 'puppeteer';
import { existsSync, unlink, readFileSync, mkdirSync } from 'fs';
import { join, dirname } from 'path';
import pkg from 'handlebars';
const { compile } = pkg;
import { fileURLToPath } from 'url';

// Definición de las constantes __filename y __dirname
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Ruta de los templates
const templatesSource = join(__dirname, '../helpers/templates/pdf');
const tmpPdfPath = join(__dirname, '../tmp/pdfs');

/**
 * @class PdfService
 * @description Clase que contiene los métodos para la generación y destrucción de PDF.
 */
class PdfService {
	/**
	 * @method destroyPDF
	 * @description Método para eliminar un archivo PDF.
	 * @static
	 * @async
	 * @memberof PdfService
	 * @param {string} file - La ruta del archivo PDF a eliminar.
	 */
	static async destroyPDF(file) {
		if (existsSync(file)) {
			unlink(file, (unlinkError) => {
				if (unlinkError) {
					console.error(`Error al eliminar el archivo subido: ${unlinkError}`);
				}
			});
		} else {
			console.error(`El archivo no existe en: ${file}`);
		}
	}

	/**
	 * @method generateReceta
	 * @description Método para generar una receta en formato PDF.
	 * @static
	 * @async
	 * @memberof PdfService
	 * @param {Object} medicamentos - El objeto que contiene los datos de los medicamentos.
	 * @returns {Promise&lt;string>} La ruta del archivo PDF generado.
	 */
	static async generateReceta(medicamentos) {
		const template = readFileSync(join(templatesSource, 'receta.handlebars'), 'utf8');
		const compiledTemplate = compile(template);
		const date = new Date();
		const monthNames = [
			'enero',
			'febrero',
			'marzo',
			'abril',
			'mayo',
			'junio',
			'julio',
			'agosto',
			'septiembre',
			'octubre',
			'noviembre',
			'diciembre',
		];

		medicamentos.fecha = `${date.getDate()} de ${
			monthNames[date.getMonth()]
		} de ${date.getFullYear()}`;

		const bodyHtml = compiledTemplate(medicamentos);
		const filename = `receta_${medicamentos.datos_paciente.nombre}_${medicamentos.datos_paciente.primer_apellido}_${medicamentos.datos_paciente.segundo_apellido}.pdf`;

		return await PdfService.#generatePDFWithTemplate(bodyHtml, filename);
	}

	/**
	 * @method generateInforme
	 * @description Método para generar un informe en formato PDF.
	 * @static
	 * @async
	 * @memberof PdfService
	 * @param {Object} informe - El objeto que contiene los datos del informe.
	 * @returns {Promise&lt;string>} La ruta del archivo PDF generado.
	 */
	static async generateInforme(informe) {
		const template = readFileSync(join(templatesSource, 'informe.handlebars'), 'utf8');
		const compiledTemplate = compile(template);
		const bodyHtml = compiledTemplate(informe);

		const filename = `informe_${informe.datos_paciente.nombre}_${informe.datos_paciente.primer_apellido}_${informe.datos_paciente.segundo_apellido}.pdf`;

		return await PdfService.#generatePDFWithTemplate(bodyHtml, filename);
	}

	/**
	 * @method generateCitaPDF
	 * @description Método para generar un PDF de una cita.
	 * @static
	 * @async
	 * @memberof PdfService
	 * @param {Object} cita - El objeto que contiene los datos de la cita.
	 * @param {string} qr - El código QR para la cita.
	 * @returns {Promise&lt;string>} La ruta del archivo PDF generado.
	 */
	static async generateCitaPDF(cita, qr) {
		const template = readFileSync(join(templatesSource, 'cita.handlebars'), 'utf8');
		const compiledTemplate = compile(template);
		const bodyHtml = compiledTemplate({ cita, qr });

		const filename = `cita_${cita.datos_paciente.nombre}_${cita.datos_paciente.primer_apellido}_${cita.datos_paciente.segundo_apellido}.pdf`;

		return await PdfService.#generatePDFWithTemplate(bodyHtml, filename);
	}

	/**
	 * @method generatePDFWithTemplate
	 * @description Método privado para generar un PDF con una plantilla.
	 * @static
	 * @async
	 * @memberof PdfService
	 * @param {string} bodyHtml - El contenido HTML del cuerpo del PDF.
	 * @param {string} filename - El nombre del archivo PDF.
	 * @returns {Promise&lt;string>} La ruta del archivo PDF generado.
	 */
	static async #generatePDFWithTemplate(bodyHtml, filename) {
		const pdfPath = join(tmpPdfPath, filename);
		const dir = dirname(pdfPath);

		if (!existsSync(dir)) {
			mkdirSync(dir, { recursive: true });
		}

		await PdfService.#generatePDF(bodyHtml, pdfPath);

		return pdfPath;
	}

	/**
	 * @method generatePDF
	 * @description Método privado para generar un PDF con contenido HTML, encabezado y pie de página.
	 * @static
	 * @async
	 * @memberof PdfService
	 * @param {string} bodyHtml - El contenido HTML del cuerpo del PDF.
	 * @param {string} pdfPath - La ruta donde se guardará el archivo PDF.
	 * @returns {Promise&lt;void>} No devuelve nada.
	 */
	static async #generatePDF(bodyHtml, pdfPath) {
		const header = readFileSync(join(templatesSource, 'header.handlebars'), 'utf8');
		const compiledHeader = compile(header);

		const footer = readFileSync(join(templatesSource, 'footer.handlebars'), 'utf8');
		const compiledFooter = compile(footer);

		const headerHtml = compiledHeader({});
		const footerHtml = compiledFooter({});

		const browser = await launch();

		const page = await browser.newPage();
		await page.setContent(bodyHtml);

		const options = {
			format: 'A4',
			displayHeaderFooter: true,
			printBackground: true,
			headerTemplate: headerHtml,
			footerTemplate: footerHtml,
			margin: {
				top: '2cm',
				right: '2cm',
				bottom: '2cm',
				left: '2cm',
			},
		};

		await page.pdf({ path: pdfPath, ...options });

		await browser.close();
	}
}

// Exportación del servicio
export default PdfService;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="Helpers-JWT.html">Helpers-JWT</a></li><li><a href="Helpers-Validators-Body.html">Helpers-Validators-Body</a></li><li><a href="Helpers-Validators-Params.html">Helpers-Validators-Params</a></li><li><a href="Helpers-Validators-QueryParams.html">Helpers-Validators-QueryParams</a></li><li><a href="Util-Database.html">Util-Database</a></li><li><a href="Util-Functions.html">Util-Functions</a></li><li><a href="Util-Middleware.html">Util-Middleware</a></li></ul><h3>Classes</h3><ul><li><a href="CitaController.html">CitaController</a></li><li><a href="CitaModel.html">CitaModel</a></li><li><a href="CitaService.html">CitaService</a></li><li><a href="CodigoPostalMunicipioController.html">CodigoPostalMunicipioController</a></li><li><a href="CodigoPostalMunicipioModel.html">CodigoPostalMunicipioModel</a></li><li><a href="CodigoPostalMunicipioService.html">CodigoPostalMunicipioService</a></li><li><a href="ConsultaController.html">ConsultaController</a></li><li><a href="ConsultaModel.html">ConsultaModel</a></li><li><a href="ConsultaService.html">ConsultaService</a></li><li><a href="ContactoController.html">ContactoController</a></li><li><a href="EmailService.html">EmailService</a></li><li><a href="EspecialidadController.html">EspecialidadController</a></li><li><a href="EspecialidadModel.html">EspecialidadModel</a></li><li><a href="EspecialidadService.html">EspecialidadService</a></li><li><a href="EspecialistaController.html">EspecialistaController</a></li><li><a href="EspecialistaModel.html">EspecialistaModel</a></li><li><a href="EspecialistaService.html">EspecialistaService</a></li><li><a href="GlucometriaController.html">GlucometriaController</a></li><li><a href="GlucometriaModel.html">GlucometriaModel</a></li><li><a href="GlucometriaService.html">GlucometriaService</a></li><li><a href="InformeController.html">InformeController</a></li><li><a href="InformeModel.html">InformeModel</a></li><li><a href="InformePatologiaModel.html">InformePatologiaModel</a></li><li><a href="InformePatologiaService.html">InformePatologiaService</a></li><li><a href="InformeService.html">InformeService</a></li><li><a href="LogController.html">LogController</a></li><li><a href="LogService.html">LogService</a></li><li><a href="MedicamentoController.html">MedicamentoController</a></li><li><a href="MedicamentoModel.html">MedicamentoModel</a></li><li><a href="MedicamentoService.html">MedicamentoService</a></li><li><a href="MunicipioController.html">MunicipioController</a></li><li><a href="MunicipioModel.html">MunicipioModel</a></li><li><a href="MunicipioService.html">MunicipioService</a></li><li><a href="PacienteController.html">PacienteController</a></li><li><a href="PacienteModel.html">PacienteModel</a></li><li><a href="PacienteService.html">PacienteService</a></li><li><a href="PacienteTomaMedicamentoController.html">PacienteTomaMedicamentoController</a></li><li><a href="PacienteTomaMedicamentoModel.html">PacienteTomaMedicamentoModel</a></li><li><a href="PacienteTomaMedicamentoService.html">PacienteTomaMedicamentoService</a></li><li><a href="PatologiaController.html">PatologiaController</a></li><li><a href="PatologiaModel.html">PatologiaModel</a></li><li><a href="PatologiaService.html">PatologiaService</a></li><li><a href="PdfService.html">PdfService</a></li><li><a href="ProvinciaController.html">ProvinciaController</a></li><li><a href="ProvinciaModel.html">ProvinciaModel</a></li><li><a href="ProvinciaService.html">ProvinciaService</a></li><li><a href="TensionArterialController.html">TensionArterialController</a></li><li><a href="TensionArterialModel.html">TensionArterialModel</a></li><li><a href="TensionArterialService.html">TensionArterialService</a></li><li><a href="TipoViaController.html">TipoViaController</a></li><li><a href="TipoViaModel.html">TipoViaModel</a></li><li><a href="TipoViaService.html">TipoViaService</a></li><li><a href="TokenModel.html">TokenModel</a></li><li><a href="TokenService.html">TokenService</a></li><li><a href="TomaModel.html">TomaModel</a></li><li><a href="TomaService.html">TomaService</a></li><li><a href="UsuarioController.html">UsuarioController</a></li><li><a href="UsuarioModel.html">UsuarioModel</a></li><li><a href="UsuarioService.html">UsuarioService</a></li></ul><h3>Global</h3><ul><li><a href="global.html">getConsultaListado</a></li><li><a href="global.html">getReceta</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Thu Jun 06 2024 19:28:25 GMT+0200 (hora de verano de Europa central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
